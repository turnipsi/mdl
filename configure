#!/bin/sh
# $Id: configure,v 1.5 2016/04/20 20:30:43 je Exp $

# Copyright (c) 2016 Juha Erkkil√§ <je@turnipsi.no-ip.org>
#
# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

set -eu

cc=${CC:-cc}
srcdir="$(dirname $0)/src"
config_h_path="${srcdir}/config.h"
config_mk_path="${srcdir}/config.mk"
include_compat_h=false

append_to_config_h()  {
  echo "$1" >> "$config_h_path"
}

append_to_config_mk() { echo "$1" >> "$config_mk_path"; }

init_config() {
  cat /dev/null > "$config_h_path"
  cat /dev/null > "$config_mk_path"
}

show_config() {
  if [ -s "$config_h_path" ]; then
    echo
    echo "Created the following config.h:"
    sed 's/^/    /' "$config_h_path"
  fi
  if [ -s "$config_mk_path" ]; then
    echo
    echo "Created the following config.mk:"
    sed 's/^/    /' "$config_mk_path"
  fi
}

check_cc() {
  ${cc} -c -x c -Werror-implicit-function-declaration -o /dev/null - \
    2>/dev/null
}

check_pledge() {
  check_cc <<'EOF'
#include <unistd.h>
void test(void) { pledge(NULL, NULL); }
EOF
}

check_sndio() {
  check_cc <<'EOF'
#include <sndio.h>
EOF
}

check_strlcpy() {
  check_cc <<'EOF'
#include <string.h>
void test(void) { strlcpy(NULL, NULL, 0); }
EOF
}

check_strsep() {
  check_cc <<'EOF'
#include <string.h>
void test(void) { strsep(NULL, NULL); }
EOF
}

check_strtonum() {
  check_cc <<'EOF'
#include <stdlib.h>
void test(void) { strtonum(NULL, 0, 0, NULL); }
EOF
}

do_check() {
  checkname=$1
  checkfunc=$2
  config_variable=$3
  compat_code=$4

  echo -n "Checking for ${checkname}... "
  if $checkfunc; then
    echo ok.
    if [ -n "$config_variable" ]; then
      append_to_config_h "#define ${config_variable} 1"
    fi
  else
    echo NOT found.
    if [ -n "$compat_code" ]; then
      include_compat_h=true
      append_to_config_mk "SRCS += ${compat_code}"
    fi
  fi
}

init_config

do_check 'pledge()'   check_pledge   HAVE_PLEDGE   pledge.c
do_check 'sndio'      check_sndio    HAVE_SNDIO    ''
do_check 'strlcpy()'  check_strlcpy  HAVE_STRLCPY  strlcpy.c
do_check 'strtonum()' check_strtonum HAVE_STRTONUM strtonum.c
do_check 'strsep()'   check_strsep   HAVE_STRSEP   strsep.c

if $include_compat_h; then
  echo '#include "compat/compat.h"' >> "$config_h_path"
fi

show_config
